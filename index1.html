<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | EXGI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="style1.css">
    <style>
        .withdraw-btn { background: linear-gradient(135deg, #ff416c, #ff4b2b) !important; color: white !important; }
        .maturity-btn { background: linear-gradient(135deg, #3b82f6, #2563eb) !important; color: white !important; }
        .deposit-input-box { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); padding: 12px; border-radius: 12px; width: 100%; color: white; outline: none; transition: 0.3s; }
        .deposit-input-box:focus { border-color: #eab308; box-shadow: 0 0 15px rgba(234, 179, 8, 0.2); }
        .luxury-table { width: 100%; border-collapse: collapse; min-width: 600px; }
        .luxury-table th { padding: 15px; text-align: left; border-bottom: 2px solid rgba(234, 179, 8, 0.2); color: #eab308; font-size: 11px; font-family: 'Orbitron'; text-transform: uppercase; }
        .luxury-table td { padding: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); font-size: 13px; font-weight: 600; }
        .premium-border { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; backdrop-filter: blur(10px); }
        .gold-btn { background: #eab308; color: black; padding: 8px 20px; border-radius: 10px; font-weight: 800; cursor: pointer; transition: 0.3s; }
    </style>
</head>
<body class="bg-[#050505] text-white"> 

    <div id="header-placeholder"></div>
    <div id="sidebar-placeholder"></div>

    <main class="max-w-7xl mx-auto px-6 relative z-10 pt-10 pb-20">
        <div class="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4 mb-8">
            <div class="premium-border p-4 text-center">
                <p class="text-[9px] font-bold text-gray-400 uppercase">Total Deposits</p>
                <h3 class="text-lg font-black orbitron flex items-center justify-center text-yellow-500">
                    <span class="mr-2">$</span><span id="total-deposit-display">0.00</span>
                </h3>
            </div>
            <div class="premium-border p-4 text-center">
                <p class="text-[9px] font-bold text-gray-400 uppercase">Active Deposit</p>
                <h3 class="text-lg font-black orbitron text-green-400 flex items-center justify-center">
                    <span class="mr-2">$</span><span id="active-deposit">0.00</span>
                </h3>
            </div>
            <div class="premium-border p-4 text-center">
                <p class="text-[9px] font-bold text-gray-400 uppercase">Total Earned</p>
                <h3 class="text-lg font-black orbitron text-green-500 flex items-center justify-center">
                    <span class="mr-2">$</span><span id="total-earned">0.00</span>
                </h3>
            </div>
            <div class="premium-border p-4 text-center">
                <p class="text-[9px] font-bold text-gray-400 uppercase">Withdrawable</p>
                <h3 class="text-lg font-black orbitron text-emerald-400 flex items-center justify-center">
                    <span class="mr-2">$</span><span id="withdrawable-display">0.00</span>
                </h3>
            </div>
            <div class="premium-border p-4 text-center">
                <p class="text-[9px] font-bold text-yellow-500 uppercase">Rank</p> 
                <h3 id="rank-display" class="text-lg font-black orbitron text-yellow-500 uppercase">...</h3>
            </div>
            <div class="premium-border p-4 text-center">
                <p class="text-[9px] font-bold text-red-400 uppercase">Total Withdrawal</p>
                <h3 class="text-lg font-black orbitron text-red-400 flex items-center justify-center">
                    <span class="mr-2">$</span><span id="total-withdrawn">0.00</span>
                </h3>
            </div>
        </div>

        <div class="premium-border p-6 mb-8">
            <p class="text-[10px] font-black orbitron text-yellow-500 uppercase mb-3">Your Referral Link</p>
            <div class="flex items-center gap-3 bg-black/40 p-2 pl-4 rounded-xl border border-white/10">
                <input id="refURL" type="text" readonly value="Connect wallet..." class="bg-transparent border-none outline-none w-full text-xs text-gray-300 font-mono">
                <button onclick="copyLink()" class="gold-btn !py-2">COPY</button>
            </div>
        </div>

        <div class="premium-border p-6 mb-8 bg-yellow-500/5 border-yellow-500/20">
            <div class="flex flex-col md:flex-row items-center gap-4">
                <div class="w-full md:w-1/2">
                    <p class="text-[10px] font-black orbitron text-yellow-500 uppercase mb-2 ml-1">Deposit Amount (USDT)</p>
                    <input type="number" id="deposit-amount" placeholder="Min 10 USDT" class="deposit-input-box font-black orbitron text-lg">
                </div>
                <div class="w-full md:w-1/2 md:pt-6">
                    <button onclick="handleInvest()" id="deposit-btn" class="gold-btn w-full !py-4 orbitron font-black tracking-widest bg-gradient-to-r from-yellow-500 to-yellow-700">
                        DEPOSIT NOW <i data-lucide="arrow-up-right" class="w-4 h-4 inline-block ml-1"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="premium-border p-8 text-center bg-emerald-950/20">
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Working Balance</p>
                <h3 class="text-4xl font-black orbitron text-white mb-6">
                    <span class="text-yellow-500 mr-2">$</span><span id="withdrawable-balance-main">0.00</span>
                </h3>
                <button onclick="handleClaim()" class="gold-btn withdraw-btn w-full">WITHDRAW WORKING</button>
            </div>
            <div class="premium-border p-8 text-center bg-blue-950/20">
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Maturity ROI (Locked)</p>
                <h3 class="text-4xl font-black orbitron text-white mb-6">
                    <span class="text-blue-500 mr-2">$</span><span id="maturity-balance">0.00</span>
                </h3>
                <button onclick="handleMaturityWithdraw()" class="gold-btn maturity-btn w-full">WITHDRAW MATURITY</button>
            </div>
        </div>

        <div class="premium-border p-8 mb-8">
            <div class="flex justify-between items-center mb-10">
                <h2 class="text-xl font-black orbitron italic uppercase">Earnings <span class="text-green-400">Status</span></h2>
                <span id="status-badge" class="px-4 py-1 rounded-full bg-red-500/20 text-red-500 text-[10px] font-black border border-red-500/30 uppercase">● Checking...</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="inner-plate p-8 bg-black/20 rounded-2xl border border-white/5">
                    <p class="text-xs font-black text-yellow-500 uppercase mb-2">Live Pending ROI</p>
                    <h4 class="text-4xl font-black orbitron text-white"><span class="text-yellow-500 mr-3">$</span><span id="projected-return">0.0000</span></h4>
                </div>
                <div class="inner-plate p-8 bg-black/20 rounded-2xl border border-white/5">
                    <p class="text-xs font-black text-yellow-500 uppercase mb-2">Next Settlement (UTC)</p>
                    <h4 id="next-timer" class="text-4xl font-black orbitron text-white">00:00:00</h4>
                </div>
            </div>
        </div>

        <div class="premium-border p-6 overflow-hidden">
            <div class="flex items-center gap-2 mb-6">
                <i data-lucide="history" class="w-5 h-5 text-yellow-500"></i>
                <h3 class="text-xl font-black orbitron italic uppercase">Investment <span class="text-yellow-500">History</span></h3>
            </div>
            <div class="overflow-x-auto">
                <table class="luxury-table">
                    <thead>
                        <tr>
                            <th># Index</th>
                            <th>Amount</th>
                            <th>ROI Rate</th>
                            <th>Start Date</th>
                            <th>Days Left</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body">
                        <tr>
                            <td colspan="6" class="text-center py-10 text-gray-500 orbitron text-xs">No active investments found</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="components.js"></script> 
    <script src="web3-handler.js"></script>

    <script>
    lucide.createIcons();

    async function initDashboard() {
        if (window.contract && window.signer) {
            const address = await window.signer.getAddress();
            loadDashboardData(address);
            startUTCCountdown(); 
        } else {
            setTimeout(initDashboard, 1000);
        }
    }

    function startUTCCountdown() {
        const timerEl = document.getElementById('next-timer');
        setInterval(() => {
            const now = new Date();
            const nextMidnight = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() + 1, 0, 0, 0));
            const diff = nextMidnight - now;
            if (diff <= 0) location.reload();
            const h = Math.floor(diff / 3600000).toString().padStart(2, '0');
            const m = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0');
            const s = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
            timerEl.innerText = `${h}:${m}:${s}`;
        }, 1000);
    }

   async function loadDashboardData(address) {
        try {
            const data = await window.contract.fetchAllUserData(address);
            const liveStats = await window.contract.getLiveStat(address);

            const fmt = (val) => parseFloat(ethers.utils.formatUnits(val, 18)).toFixed(2);
            const fmt4 = (val) => parseFloat(ethers.utils.formatUnits(val, 18)).toFixed(4);

            // Stats Update
            document.getElementById('total-deposit-display').innerText = fmt(data.totalSelfInvestment);
            document.getElementById('active-deposit').innerText = fmt(data.totalSelfInvestment);
            document.getElementById('total-earned').innerText = fmt(data.totalLevelIncome.add(data.totalLevelROIIncome));
            document.getElementById('withdrawable-display').innerText = fmt(data.availableWithdrawable);
            document.getElementById('withdrawable-balance-main').innerText = fmt(data.availableWithdrawable);
            document.getElementById('total-withdrawn').innerText = fmt(data.totalWithdrawn);
            document.getElementById('projected-return').innerText = fmt4(liveStats[1]);
            document.getElementById('maturity-balance').innerText = fmt(data.pendingMaturity);
            document.getElementById('rank-display').innerText = data.username ? "MEMBER" : "...";

            const statusBadge = document.getElementById('status-badge');
            if(parseFloat(fmt(data.totalSelfInvestment)) > 0) {
                statusBadge.innerText = "● Active Status";
                statusBadge.className = "px-4 py-1 rounded-full bg-green-500/20 text-green-500 text-[10px] font-black border border-green-500/30 uppercase";
            }

            if(data.username) {
                document.getElementById('refURL').value = `${window.location.origin}/register.html?ref=${data.username}`;
            }

            // --- INVESTMENT HISTORY TABLE (FIXED) ---
            const historyBody = document.getElementById('history-table-body');
            
            // Aapke contract se history fetch kar rahe hain
            const historyData = await window.contract.getTransactionHistory(address);
            
            if (historyData && historyData.length > 0) {
                // Sirf DEPOSIT (Type 0) transactions ko filter kar rahe hain
                const deposits = historyData.filter(t => t.tType === 0);
                
                if(deposits.length > 0) {
                    historyBody.innerHTML = ''; // Table clear karein
                    deposits.forEach((t, i) => {
                        const amt = parseFloat(ethers.utils.formatUnits(t.amount, 18));
                        const date = new Date(t.timestamp * 1000).toLocaleDateString();
                        
                        // Contract logic ke hisaab se Rate aur Days calculate karna
                        let rate = "0.95%";
                        let days = "210";
                        if(amt > 500) { rate = "1.33%"; days = "150"; }
                        else if(amt > 100) { rate = "1.11%"; days = "180"; }
                        
                        historyBody.innerHTML += `
                            <tr>
                                <td class="orbitron text-gray-500">#${i + 1}</td>
                                <td class="text-yellow-500 font-bold">$${amt.toFixed(2)}</td>
                                <td class="text-green-400 font-bold">${rate}</td>
                                <td class="text-gray-400">${date}</td>
                                <td class="text-gray-400">${days} Days</td>
                                <td>
                                    <span class="px-2 py-1 rounded bg-green-500/10 text-green-500 text-[10px] border border-green-500/20 font-bold">
                                        ACTIVE
                                    </span>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    historyBody.innerHTML = '<tr><td colspan="6" class="text-center py-10 text-gray-500 orbitron text-xs">No deposits found</td></tr>';
                }
            }
        } catch (err) { 
            console.error("Load Error:", err); 
        }
    }
    async function handleMaturityWithdraw() {
        try {
            const tx = await window.contract.withdrawMaturity(0); 
            alert("Processing Maturity Withdrawal...");
            await tx.wait();
            alert("Success!");
            location.reload();
        } catch (e) { alert(e.message.includes("Cycle") ? "Cycle not complete!" : "Failed"); }
    }

    function copyLink() {
        const refInput = document.getElementById('refURL');
        if (refInput.value.includes("Connect")) return alert("Connect Wallet First!");
        navigator.clipboard.writeText(refInput.value);
        alert("Copied!");
    }

    window.addEventListener('load', initDashboard);
    </script>
</body>
</html>

