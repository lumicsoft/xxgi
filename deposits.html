<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Active Deposits | EXGI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .status-badge { background: rgba(34, 197, 94, 0.1); color: #22c55e; padding: 4px 12px; border-radius: 100px; font-size: 10px; font-weight: 800; text-transform: uppercase; border: 1px solid rgba(34, 197, 94, 0.3); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .progress-container { background: rgba(255,255,255,0.05); height: 6px; border-radius: 10px; overflow: hidden; }
        .progress-bar { background: linear-gradient(90deg, #f59e0b, #fbbf24); height: 100%; box-shadow: 0 0 10px rgba(245, 158, 11, 0.5); transition: width 1s ease-in-out; }
        .usdt-icon { width: 20px; height: 20px; display: inline-block; vertical-align: middle; margin-right: 6px; }
        .usdt-icon-sm { width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin-right: 4px; }
        .premium-border { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; }
        .orbitron { font-family: 'Orbitron', sans-serif; }
    </style>
</head>
<body class="bg-[#050505] text-white">

    <main class="max-w-7xl mx-auto px-6 relative z-10 pt-10">
        <div class="flex justify-between items-center mb-10">
            <div>
                <h1 class="text-3xl font-black orbitron italic uppercase tracking-tighter">Active <span class="text-yellow-500">Deposits</span></h1>
                <p id="wallet-status" class="text-red-500 text-[10px] font-bold uppercase tracking-[0.2em]">Wallet Not Connected</p>
            </div>
            <button onclick="connectWallet()" id="connect-btn" class="bg-yellow-500 text-black px-6 py-2 rounded-xl font-black orbitron text-[10px] hover:bg-yellow-400 transition-all">
                CONNECT WALLET
            </button>
        </div>

        <div class="grid grid-cols-2 gap-6 mb-10">
            <div class="premium-border p-6 text-center">
                <p class="text-[10px] font-black text-gray-400 uppercase mb-1">Total Available Balance</p>
                <h3 class="text-2xl font-black orbitron text-white flex items-center justify-center">
                    <img src="https://cryptologos.cc/logos/tether-usdt-logo.svg?v=024" class="usdt-icon">
                    <span id="total-active-capital">0.00</span>
                </h3>
            </div>
            <div class="premium-border p-6 text-center">
                <p class="text-[10px] font-black text-yellow-500 uppercase mb-1">Live Pending ROI</p>
                <h3 class="text-2xl font-black orbitron text-green-400 flex items-center justify-center">
                    <img src="https://cryptologos.cc/logos/tether-usdt-logo.svg?v=024" class="usdt-icon">
                    <span id="total-daily-profit">0.00</span>
                </h3>
            </div>
        </div>

        <div id="deposits-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 pb-20">
            <div class="col-span-full text-center py-20">
                <p class="orbitron text-xs text-gray-500 uppercase tracking-widest">Connect wallet to scan nodes...</p>
            </div>
        </div>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

    <script>
        // --- CONFIGURATION ---
        const CONTRACT_ADDRESS = "0x1E526fb7ae52b451e4e86e376B4531Cae9b192D6"; // <--- APNA ADDRESS YAHA DAALEIN
        const ABI = [
            "function users(address) view returns (string username, address sponsor, uint256 directCount, uint256 workingBalance, uint256 totalWithdrawn, uint256 statLevelIncome, uint256 statLevelROIIncome)",
            "function positions(address, uint256) view returns (uint256 amount, uint256 startTime, uint256 lastAutoClosing, uint256 dailyRate, uint256 duration, bool isWithdrawn, bool active)",
            "function getUserDashboard(address) view returns (tuple(uint256 totalLevelIncome, uint256 totalLevelROIIncome, uint256 totalDirectActive, uint256 totalDirectInactive, uint256 totalTeamActive, uint256 totalTeamInactive, uint256 totalIncome, uint256 totalROIIncome, uint256 totalWithdrawal, uint256 availableBalance, uint256 livePendingROI))",
            "function withdrawMaturity(uint256) external"
        ];

        let provider, signer, contract;

        // --- WALLET CONNECTION ---
        async function connectWallet() {
            if (window.ethereum) {
                try {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    await provider.send("eth_requestAccounts", []);
                    signer = provider.getSigner();
                    const address = await signer.getAddress();
                    
                    contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
                    
                    // Update UI
                    document.getElementById('wallet-status').innerText = "CONNECTED: " + address.substring(0, 6) + "..." + address.substring(38);
                    document.getElementById('wallet-status').className = "text-green-500 text-[10px] font-bold uppercase tracking-[0.2em]";
                    document.getElementById('connect-btn').innerText = "REFRESH DATA";
                    
                    loadActiveDeposits();
                } catch (err) {
                    console.error("Connection error", err);
                    alert("Wallet connection failed!");
                }
            } else {
                alert("Please install MetaMask!");
            }
        }

        // --- LOAD DATA ---
        async function loadActiveDeposits() {
            const grid = document.getElementById('deposits-grid');
            const capDisplay = document.getElementById('total-active-capital');
            const profitDisplay = document.getElementById('total-daily-profit');
            
            if (!contract) return;

            grid.innerHTML = `<div class="col-span-full text-center py-20"><div class="inline-block animate-spin text-yellow-500 mb-4"><i data-lucide="refresh-cw" class="w-10 h-10"></i></div><p class="orbitron text-xs text-gray-500 uppercase tracking-widest">Scanning Blockchain...</p></div>`;
            if (window.lucide) lucide.createIcons();

            try {
                const address = await signer.getAddress();
                
                // Fetch Dashboard Stats
                const dash = await contract.getUserDashboard(address);
                if(capDisplay) capDisplay.innerText = parseFloat(ethers.utils.formatUnits(dash.availableBalance, 18)).toFixed(2);
                if(profitDisplay) profitDisplay.innerText = parseFloat(ethers.utils.formatUnits(dash.livePendingROI, 18)).toFixed(2);

                let html = '';
                let hasNodes = false;

                // Loop through positions (Max 50 checking)
                for (let i = 0; i < 50; i++) { 
                    try {
                        const p = await contract.positions(address, i);
                        
                        if (p.amount.eq(0)) break; 

                        const amount = parseFloat(ethers.utils.formatUnits(p.amount, 18));
                        hasNodes = true;

                        const startTime = p.startTime.toNumber();
                        const rate = p.dailyRate.toNumber(); 
                        const duration = p.duration.toNumber();
                        const isWithdrawn = p.isWithdrawn;
                        const isActive = p.active;

                        const nodeDailyYield = (amount * rate) / 10000;
                        const currentTime = Math.floor(Date.now() / 1000);
                        let progress = (((currentTime - startTime) / (duration * 86400)) * 100).toFixed(2);
                        if (progress > 100) progress = 100;
                        if (progress < 0) progress = 0;

                        html += `
                        <div class="premium-border p-6 hover:border-yellow-500/30 transition-all duration-300">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <p class="text-[9px] text-yellow-500 font-bold uppercase tracking-widest">NODE #${i + 1}</p>
                                    <h3 class="text-xl font-black orbitron text-white flex items-center">
                                        <img src="https://cryptologos.cc/logos/tether-usdt-logo.svg?v=024" class="usdt-icon-sm">
                                        ${amount.toFixed(2)}
                                    </h3>
                                </div>
                                <span class="${isActive && !isWithdrawn ? 'status-badge' : 'bg-white/10 text-gray-500 px-3 py-1 text-[8px] rounded-full'}">
                                    ${isWithdrawn ? 'WITHDRAWN' : (isActive ? 'MINING' : 'MATURED')}
                                </span>
                            </div>

                            <div class="grid grid-cols-2 gap-3 mb-6">
                                <div class="bg-white/5 border border-white/10 rounded-xl p-3">
                                    <p class="text-[8px] text-gray-500 uppercase font-black mb-1">Daily Profit</p>
                                    <p class="text-xs font-bold text-green-400">+${nodeDailyYield.toFixed(2)}</p>
                                </div>
                                <div class="bg-white/5 border border-white/10 rounded-xl p-3">
                                    <p class="text-[8px] text-gray-500 uppercase font-black mb-1">ROI Rate</p>
                                    <p class="text-xs font-bold text-white">${(rate/100).toFixed(2)}%</p>
                                </div>
                            </div>

                            <div class="space-y-2 mb-4">
                                <div class="flex justify-between text-[10px] font-bold orbitron">
                                    <span class="text-gray-400">PROGRESS</span>
                                    <span class="text-white">${progress}%</span>
                                </div>
                                <div class="progress-container"><div class="progress-bar" style="width: ${progress}%"></div></div>
                            </div>

                            ${progress >= 100 && !isWithdrawn ? `
                                <button onclick="withdrawMaturityNode(${i})" class="w-full py-3 bg-yellow-500 text-black font-black orbitron text-[10px] rounded-xl hover:bg-yellow-400 transition-all shadow-lg shadow-yellow-500/20">
                                    CLAIM PRINCIPAL
                                </button>
                            ` : `
                                <div class="text-center py-2 bg-white/5 rounded-lg border border-white/5">
                                    <p class="text-[8px] text-gray-500 font-bold orbitron uppercase tracking-widest">Locked: ${duration} Days</p>
                                </div>
                            `}
                        </div>`;
                    } catch (err) {
                        break; 
                    }
                }

                grid.innerHTML = hasNodes ? html : `<div class="col-span-full text-center py-20 border-2 border-dashed border-white/5 rounded-3xl"><p class="orbitron text-xs text-gray-600 uppercase tracking-widest">No Deposits Found</p></div>`;
                if (window.lucide) lucide.createIcons();

            } catch (err) {
                console.error(err);
                grid.innerHTML = `<div class="col-span-full text-center py-20 text-red-500 orbitron text-xs">CONTRACT ERROR</div>`;
            }
        }

        async function withdrawMaturityNode(idx) {
            try {
                const tx = await contract.withdrawMaturity(idx);
                alert("Transaction Sent! Waiting for confirmation...");
                await tx.wait();
                alert("Withdrawal Successful!");
                loadActiveDeposits();
            } catch (err) {
                alert("Error: " + (err.data?.message || err.message));
            }
        }
    </script>
</body>
</html>

